<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="og:site_name" content="Blog"/><link rel="canonical" href="https://your-website-url.com/posts/gitlab-tutorial"/><meta name="twitter:url" content="https://your-website-url.com/posts/gitlab-tutorial"/><meta name="og:url" content="https://your-website-url.com/posts/gitlab-tutorial"/><title>使用 gitlab 搭建代码托管平台 | Blog</title><meta name="twitter:title" content="使用 gitlab 搭建代码托管平台 | Blog"/><meta name="og:title" content="使用 gitlab 搭建代码托管平台 | Blog"/><meta name="description" content="开发团队中如何更好的进行代码管理和协作，如何免费搭建一台代码托管平台，这篇文章会给你答案"/><meta name="twitter:description" content="开发团队中如何更好的进行代码管理和协作，如何免费搭建一台代码托管平台，这篇文章会给你答案"/><meta name="og:description" content="开发团队中如何更好的进行代码管理和协作，如何免费搭建一台代码托管平台，这篇文章会给你答案"/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to Blog"/></head><body class="item-page"><header><div class="wrapper"><a class="site-name" href="/">Blog</a></div></header><div class="wrapper"><article><div class="content"><h1>使用 gitlab 搭建代码托管平台</h1><p><a href="https://github.com">github</a>是目前最为流行的代码托管平台，很多著名的开源项目都在github上进行托管。但github只能免费托管公有项目，如果要托管私有项目就要缴纳不菲的费用。而且github服务器在国外，很难保证网络的稳定。为了保证代码的安全和可控，公司更倾向于自建代码服务器。</p><h2>gitlab是什么</h2><blockquote><p>Version Control on your Server like GitHub but Open Source</p></blockquote><p>一句话，gitlab就是github的开源实现。它的特点如下：</p><ul><li>git仓库管理，代码审查，问题追踪，活动信息，维基和持续集成。</li><li>容纳25000+的用户群同时在一台服务器上。LDAP/AD组同步和日志审计。</li><li>社区驱动，700+贡献者，检查完善代码，方便集成。</li><li>如果不想手动搭建gitlab，可以看<a href="https://about.gitlab.com/pricing/#gitlab-com">这里</a></li></ul><h2>如何搭建</h2><h3>部署环境ubuntu14.04 server版操作系统</h3><p>我们公司主机CPU是32位的，所以下载32位的ubuntu镜像。下载地址在<a href="http://www.ubuntu.org.cn/download/server">这里</a>，安装过程就不说了，我是用光驱引导安装的，当然也有其他方法。</p><h3>安装openssh-server</h3><p>为什么要安装它呢？<code>openssh-server</code>主要用于其他终端远程连接服务器。默认ubuntu14.04系统只有<code>openssh-client</code>，而<code>openssh-server</code>需要自己安装。怎么看系统有没有安装ssh呢，通过如下命令：<code>dpkg --list|grep ssh</code>，如果有的话，控制台会列出<code>openssh-client</code>和<code>openssh-server</code>，说明已经安装了，如果没有<code>openssh-server</code>，需要通过如下命令安装<code>sudo apt-get install openssh-server</code>，结果在安装这个的时候报错</p><pre><code><span class="type">Reading</span> package lists... <span class="type">Done
Building</span> dependency tree
<span class="type">Reading</span> state information... <span class="type">Done
Package</span> openssh-server <span class="keyword">is</span> not available,but <span class="keyword">is</span> referred to by another package. <span class="type">This</span> may mean that the package <span class="keyword">is</span> missing, has been obsoleted, is only available from another source
<span class="type">E</span>: <span class="type">Package</span> 'openssh-server' has no installation candidate
</code></pre><p>google了一下，解决方案是更新包</p><pre><code>sudo apt-<span class="keyword">get</span> update
sudo apt-<span class="keyword">get</span> upgrade
</code></pre><p>结果又报了如下错误：</p><pre><code><span class="type">Reading</span> package lists... <span class="type">Done
Building</span> dependency tree
<span class="type">Reading</span> state information... <span class="type">Done
Some</span> packages could not be install.  <span class="type">This</span> may mean that you have requested an impossible situation or <span class="keyword">if</span> you are using the unstable distribution that <span class="keyword">some required</span> packages have not yet been created or been moved out of <span class="type">Incoming</span>.
<span class="type">The</span> following information may help to resolve the situation:

<span class="type">The</span> following packages have unmet dependencies:
openssh-server : <span class="type">Depends</span>: <span class="call">libwrap0</span>(&gt;= <span class="number">7.6</span>-<span class="number">4</span>~) but it <span class="keyword">is</span> not installable

<span class="type">Unable</span> to correct problems, you have held broken packages.
</code></pre><p>控制台提示的意思是，安装<code>openssh-server</code>要依赖<code>libwrap0</code>这个库，于是我就又执行了<code>sudo apt-get install libwrap0</code>。结果又打印了一堆类似错误，提示又要依赖其他的库，于是觉的不对劲了，又google了一下，找到了原因，是因为在<code>sudo apt-get update</code>的时候没有update完全。遇到了 <strong>"Hash sum mismatch"</strong> error。怎么解决呢？</p><pre><code>sudo rm -rf /<span class="keyword">var</span>/lib/apt/lists<span class="comment">/*   //首先清空/var/lib/apt/lists/目录，然后更新
sudo apt-get update</span>
</code></pre><p>然后<code>openssh-server</code>就顺利安装上了，网上解决方案地址在<a href="http://askubuntu.com/questions/575639/cant-get-anything-to-install-dependency-errors">这里</a>。 如何判断sshserver是否启动了呢？</p><pre><code>ps -e | grep ssh
</code></pre><p>如果只有<code>ssh-agent</code>，那说明<code>ssh-server</code>还没有启动，需要</p><pre><code>/etc/<span class="keyword">init</span>.<span class="property">d</span>/ssh start
</code></pre><p><code>ssh-server</code>配置文件位于<code>/ etc/ssh/sshd_config</code>，在这里可以定义SSH的服务端口，默认端口是22，你可以自己定义成其他端口号，如222。然后重启SSH服务：</p><pre><code>sudo /etc/<span class="keyword">init</span>.<span class="property">d</span>/ssh resart
</code></pre><p>一般情况下用默认端口就行，操作完毕，这样我就可以在自己的电脑上通过ssh远程链接主机服务器了。</p><h3>安装gitlab包</h3><p>在安装gitlab包的时候又遇到个麻烦，gitlab官网的<a href="https://about.gitlab.com/downloads/">下载页面</a>根本没有提供任何32位的包，全部是amd64。我立马郁闷了，好不容易到这儿了，难道还要换台64位的主机。为了给公司少找麻烦，我还是自己先找找有没有什么workaround吧，功夫不负有心人，终于找到了一个方案<a href="https://bitnami.com/stack/gitlab">bitnami gitlab</a>，提供一键式安装gitlab，最主要支持32位，太棒了！操作很简单</p><p>第一步下载<a href="https://bitnami.com/stack/gitlab/installer">installer</a></p><pre><code>wget https://downloads.<span class="property">bitnami</span>.<span class="property">com</span>/files/stacks/gitlab/<span class="number">7.6.2</span>-<span class="number">0</span>/bitnami-gitlab-<span class="number">7.6.2</span>-<span class="number">0</span>-linux-installer.<span class="property">run</span>
</code></pre><p>第二步安装installer</p><pre><code>chmod <span class="number">744</span> bitnami-gitlab-<span class="number">7.6.2</span>-<span class="number">0</span>-linux-installer.<span class="property">run</span> <span class="comment">//这步很关键，否则提示 command not found</span>
./bitnami-gitlab-<span class="number">7.6.2</span>-<span class="number">0</span>-linux-installer.<span class="property">run</span>
</code></pre><p>接下来就是一步一步安装了，需要配置很多信息，具体配置说明可以看<a href="https://bitnami.com/stack/gitlab/README.txt">这里</a></p><p>等配置完了，我在自己电脑浏览器输入 192.168.30.196 ，神奇的事情发生啦，gitlab服务器跑起来了。输入用户名，密码即可登录。</p><h3>gitlab邮件系统</h3><p>gitlab内置邮件系统，这样用户在执行相关操作的时候会自动发邮件来通知相关成员。 这个功能很赞，下面说一下配置流程：</p><p>1 首先申请一个新的邮箱 <code>xxx@163.com</code>。</p><p>2 <code>sudo vi /opt/gitlab-7.6.2-0/apps/gitlab/htdocs/config/environments/production.rb</code></p><p>修改如下信息：</p><pre><code>config.<span class="property">action_mailer</span>.<span class="property">smtp_settings</span> = {
:address =&gt; <span class="string">"smtp.qiye.163.com"</span>,
:port =&gt; <span class="string">"25"</span>,
:domain =&gt; <span class="string">"163.com"</span>,
:authentication =&gt; :plain,
:user_name =&gt; <span class="string">"xxx@163.com"</span>,
:password =&gt; <span class="string">"your password"</span>,
:enable_starttls_auto =&gt; <span class="keyword">false</span>
}
</code></pre><p>3 <code>sudo vi /opt/gitlab-7.6.2-0/apps/gitlab/htdocs/config/gitlab.yml</code></p><p>找到<code>email_from:</code>这一行，改成 <code>email_from: xxx@163.com</code></p><p>4 重启gitlab服务: <code>sudo /opt/gitlab-7.6.2-0/ctlscript.sh restart gitlab_sidekiq</code></p><h3>修改服务器IP地址</h3><p>如果全部按照默认选项安装，创建一个project，生成的仓库地址是这样的：<code>git@127.0.0.1:username/test.git</code>，这显然不对，因为这是本机地址，而开发人员做<code>git clone</code>操作时，是在自己的电脑上完成的，如何配置服务器IP地址？ 在gitlab.yml这个配置文件中定位到<code>host:</code>，设置IP即可 。</p><p>sudo vi /opt/gitlab-7.6.2-0/apps/gitlab/htdocs/config/gitlab.yml</p><pre><code>## <span class="type">GitLab</span> settings
gitlab:
## <span class="type">Web</span> server settings (note: host <span class="keyword">is</span> the <span class="type">FQDN</span>, do not include http://)
host: <span class="number">192.168.30.196</span> <span class="comment">//把这里改成服务器ip就可以了</span>
port: <span class="number">80</span> # <span class="type">Set</span> to <span class="number">443</span> <span class="keyword">if</span> using <span class="type">HTTPS</span>, see installation.<span class="property">md#using</span>-https <span class="keyword">for</span> additional <span class="type">HTTPS</span> configuration details
</code></pre><p>重启gitlab服务: <code>sudo /opt/gitlab-7.6.2-0/ctlscript.sh restart gitlab_sidekiq</code></p><h3>设置gitlab开机自启动</h3><p>除了这些还有什么需要做吗？那就是开机自启动，这样可以保证服务器因为各种原因重启后，gitlab服务持续可用。</p><pre><code>sudo cp /opt/gitlab-<span class="number">7.6.2</span>-<span class="number">0</span>/ctlscript.<span class="property">sh</span> /etc/<span class="keyword">init</span>.<span class="property">d</span>/bitnami-gitlab
sudo update-rc.<span class="property">d</span> -f bitnami-gitlab start <span class="number">80 2 3 4 5</span> . <span class="property">stop</span> <span class="number">30 0 1 6</span> .
</code></pre></div><span>Tagged with: </span><ul class="tag-list"><li><a href="/tags/tutorial">tutorial</a></li></ul></article><div class="item-navigator"><table><tr><td class="previous-item"><a href="/posts/website-use-hugo">👈 使用 Hugo + Travis CI + Github Pages 搭建静态博客</a></td><td></td></tr></table></div><footer><p>Generated using <a href="https://github.com/johnsundell/publish">Publish</a></p><p><a href="/feed.rss">RSS feed</a></p></footer></div></body></html>